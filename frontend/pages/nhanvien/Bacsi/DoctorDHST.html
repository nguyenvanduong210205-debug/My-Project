<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn b√°c sƒ© - Healthcare</title>
    <style>
        /* CSS Styling */
        :root {
            --blue: #007bff;
            --blue-dark: #0056b3;
            --bg: #f0f8ff;
            --card: #ffffff;
            --muted: #666;
        }
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: #333;
        }
        .layout { display: flex; min-height: 100vh; }
        aside {
            width: 260px; background: var(--card); border-right: 1px solid #d9e2ec;
            padding: 20px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        .logo { text-align: center; margin-bottom: 18px; }
        .logo img { width: 120px; }
        .doctor-info { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; background: #e8f3ff; }
        .doctor-info img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--blue); }
        .doctor-info .name { font-weight: 600; }
        nav ul { list-style: none; padding: 0; margin: 20px 0; }
        nav a {
            display: block; padding: 10px 12px; border-radius: 6px;
            color: #333; text-decoration: none; font-weight: 500;
        }
        nav a.active, nav a:hover { background: var(--blue); color: #fff; }
        main { flex: 1; padding: 25px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        header h1 { margin: 0; color: #004b91; }

        table {
            width: 100%; border-collapse: collapse; background: var(--card);
            border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        thead th { background: #e6f2ff; color: #004b91; padding: 10px; text-align: left; }
        tbody td { padding: 10px; border-bottom: 1px solid #eee; }
        tbody tr:hover { background: #f9fbff; }
        .status {
            display: inline-block; padding: 6px 10px;
            border-radius: 20px; font-weight: 700; font-size: 13px;
            text-transform: capitalize;
        }
        .status.cho_xac_nhan { background: #fff3cd; color: #856404; }
        .status.da_kham { background: #d4edda; color: #155724; }
        .status.huy { background: #f8d7da; color: #721c24; }
        .muted { color: #666; font-size: 14px; }
        .filter { margin: 10px 0 15px; display: flex; align-items: center; gap: 10px; }
        .filter input { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-primary {
            background: var(--blue); color: #fff; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
        }
        .btn-primary:hover { background: var(--blue-dark); }
        a.name-link { color: var(--blue); text-decoration: underline; cursor: pointer; }

        /* === Modal === */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 10px;
            width: 650px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .close { float: right; font-size: 22px; cursor: pointer; }

        /* Modal Form Style */
        #patientForm label { display: block; margin-top: 10px; font-weight: bold; }
        #patientForm textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside>
            <div>
                <div class="logo"><img src="logo.jpg" alt="logo"></div>
                <div class="doctor-info">
                    <img id="doctorAvatar" src="https://cdn-icons-png.flaticon.com/512/9131/9131529.png" alt="avatar">
                    <div>
                        <div class="name" id="doctorName"></div>
                        <div class="muted" id="doctorKhoa"></div>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a class="active" onclick="showSection('lich', this)">üìÖ L·ªãch & B·ªánh nh√¢n</a></li>
                        <li><a onclick="showSection('hoso', this)">ü©∫ H·ªì s∆°</a></li>
                        <li><a onclick="showSection('thongke', this)">üìä Th·ªëng k√™</a></li>
                    </ul>
                </nav>
            </div>
            <div class="muted" style="font-size:14px">
                Ca tr·ª±c: <b id="doctorCa">S√°ng</b><br>
                <button class="btn-primary" style="margin-top:10px" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </aside>

        <main>
            <header>
                <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn b√°c sƒ©</h1>
                <div class="muted" id="doctorGreeting"></div>
            </header>

            <section id="lich" class="section">
                <h3>üìÖ L·ªãch & Danh s√°ch b·ªánh nh√¢n</h3>
                <div class="filter">
                    <label for="filterDate">L·ªçc theo ng√†y kh√°m:</label>
                    <input type="date" id="filterDate" onchange="loadSchedule(this.value)">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th><th>M√£ BN</th><th>T√™n b·ªánh nh√¢n</th><th>Ng√†y kh√°m</th>
                            <th>Gi·ªù h·∫πn</th><th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="lichTableBody"><tr><td colspan="6" class="muted">ƒêang t·∫£i...</td></tr></tbody>
                </table>
            </section>

            <section id="hoso" class="section" style="display:none">
                <h3>ü©∫ H·ªì s∆° b√°c sƒ©</h3>
                <div style="text-align:right; margin-bottom:10px;">
                    <button class="btn-primary" id="editBtn" onclick="toggleEdit(true)">‚úèÔ∏è Ch·ªânh s·ª≠a h·ªì s∆°</button>
                    <button class="btn-primary" id="saveBtn" style="display:none;" onclick="saveDoctorProfile()">üíæ L∆∞u</button>
                    <button class="btn-primary" id="cancelBtn" style="display:none; background:#ccc; color:#000;" onclick="toggleEdit(false)">‚ùå H·ªßy</button>
                </div>
                <table id="hosoTable">
                    <tbody>
                        <tr><td><b>H·ªç t√™n:</b></td><td><input id="hosoName" readonly></td></tr>
                        <tr><td><b>H·ªçc v·ªã:</b></td><td><input id="hosoHocVi" readonly></td></tr>
                        <tr><td><b>Ch·ª©c v·ª•:</b></td><td><input id="hosoChucVu" readonly></td></tr>
                        <tr><td><b>Chuy√™n m√¥n:</b></td><td><input id="hosoChuyenMon" readonly></td></tr>
                        <tr><td><b>Kinh nghi·ªám (nƒÉm):</b></td><td><input id="hosoExp" readonly></td></tr>
                        <tr><td><b>Email:</b></td><td><input id="hosoEmail" readonly></td></tr>
                        <tr><td><b>ƒêi·ªán tho·∫°i:</b></td><td><input id="hosoPhone" readonly></td></tr>
                        <tr><td><b>ƒê·ªãa ch·ªâ:</b></td><td><input id="hosoAddress" readonly></td></tr>
                    </tbody>
                </table>
            </section>

            <section id="thongke" class="section" style="display:none">
                <h3>üìä Th·ªëng k√™ ho·∫°t ƒë·ªông</h3>
                <div id="thongkeData" class="muted">ƒêang t·∫£i...</div>
            </section>
        </main>
    </div>

    <div class="modal" id="patientModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chi ti·∫øt b·ªánh nh√¢n</h2>
            <form id="patientForm">
                <p><b>T√™n:</b> <span id="patientName"></span></p>
                <p><b>Gi·ªõi t√≠nh:</b> <span id="patientGender"></span></p>
                <p><b>Ng√†y sinh:</b> <span id="patientDOB"></span></p>
                <p><b>ƒê·ªãa ch·ªâ:</b> <span id="patientAddress"></span></p>
                <label for="chuandoan">Chu·∫©n ƒëo√°n:</label>
                <textarea id="chuandoan" rows="3"></textarea>
                <label for="donthuoc">ƒê∆°n thu·ªëc:</label>
                <textarea id="donthuoc" rows="3"></textarea>
                <button type="button" class="btn-primary" style="margin-top:10px" onclick="savePatient()">üíæ L∆∞u b·ªánh √°n</button>
            </form>
        </div>
    </div>

    <script>
        // 1. L·∫§Y ID B√ÅC Sƒ® T·ª™ LOCALSTORAGE V√Ä KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
        const id_bacsi = localStorage.getItem('doctorId');
        let currentPatientId = null;

        if (!id_bacsi) {
            // N·∫øu kh√¥ng c√≥ doctorId (ch∆∞a ƒëƒÉng nh·∫≠p), chuy·ªÉn h∆∞·ªõng
            alert("Phi√™n l√†m vi·ªác h·∫øt h·∫°n ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y kh·ªõp v·ªõi v·ªã tr√≠ file login.html c·ªßa b·∫°n
            window.location.href = "http://localhost:5500/login.html"; 
        }

        async function safeFetch(url, options = {}) {
            try {
                const res = await fetch(url, options);
                if (!res || !res.ok) {
                    console.error(`HTTP error: ${res ? res.status + ' ' + res.statusText : 'No response'}`);
                    return { data: null };
                }
                const json = await res.json();
                return json;
            } catch (err) {
                console.error("Fetch error:", err);
                return { data: null };
            }
        }


        // === H·ªì s∆° b√°c sƒ© ===
        async function loadProfile() {
            const { data } = await safeFetch(`http://localhost:3000/api/DoctorDHST/doctorProfile?id_bacsi=${id_bacsi}`);
            if (!data) return;
            // C·∫≠p nh·∫≠t th√¥ng tin tr√™n Sidebar
            doctorName.textContent = data.ho_ten;
            doctorKhoa.textContent = data.ten_khoa;
            doctorGreeting.textContent = `Xin ch√†o, ${data.ho_ten}`;
            // C·∫≠p nh·∫≠t th√¥ng tin trong H·ªì s∆°
            hosoName.value = data.ho_ten;
            hosoHocVi.value = data.hoc_vi;
            hosoChucVu.value = data.chuc_vu;
            hosoChuyenMon.value = data.chuyen_mon;
            hosoExp.value = data.nam_kinh_nghiem;
            hosoEmail.value = data.email;
            hosoPhone.value = data.phone;
            hosoAddress.value = data.diachi;
        }

        // === L·ªãch kh√°m ===
        async function loadSchedule(date="") {
            const tbody = document.getElementById("lichTableBody");
            tbody.innerHTML = `<tr><td colspan="6" class="muted">ƒêang t·∫£i...</td></tr>`;
            const url = date
                ? `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}&ngay=${date}`
                : `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}`;
            const { data } = await safeFetch(url);
            tbody.innerHTML = "";
            if (!data || !data.length) return tbody.innerHTML = `<tr><td colspan="6" class="muted">Kh√¥ng c√≥ l·ªãch kh√°m</td></tr>`;
            
            data.forEach((bn, i) => {
                const tr = document.createElement("tr");
                // Th√™m replace ƒë·ªÉ x·ª≠ l√Ω t√™n tr·∫°ng th√°i c√≥ kho·∫£ng tr·∫Øng (v√≠ d·ª•: "Cho X√°c Nh·∫≠n" -> "cho_xac_nhan")
                const statusClass = bn.trang_thai.toLowerCase().replace(/ /g, '_');
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td>${bn.id_benhnhan}</td>
                    <td><a class="name-link" onclick="openPatient('${bn.id_benhnhan}')">${bn.ten_benhnhan}</a></td>
                    <td>${bn.ngay}</td>
                    <td>${bn.khung_gio}</td>
                    <td><span class="status ${statusClass}">${bn.trang_thai}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        // === Chi ti·∫øt b·ªánh nh√¢n ===
        async function openPatient(idBN) {
            currentPatientId = idBN;
            const { data } = await safeFetch(`http://localhost:3000/api/benhnhan/detail?id_benhnhan=${idBN}`);
            if (!data) return;
            patientName.textContent = data.ho_ten;
            patientGender.textContent = data.gioi_tinh;
            patientDOB.textContent = data.ngay_sinh;
            patientAddress.textContent = data.dia_chi;
            
            // X√≥a n·ªôi dung c≈© khi m·ªü modal m·ªõi
            chuandoan.value = "";
            donthuoc.value = "";
            
            patientModal.style.display = "flex";
        }

        async function savePatient() {
            if (!currentPatientId) return alert("‚ùå Ch∆∞a ch·ªçn b·ªánh nh√¢n");
            const body = {
                id_benhnhan: currentPatientId,
                id_bacsi, // S·ª≠ d·ª•ng id_bacsi t·ª´ localStorage
                chuan_doan: chuandoan.value.trim(),
                don_thuoc: donthuoc.value.trim()
            };
            const res = await fetch("http://localhost:3000/api/hosokham/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            if (res.ok) {
                alert("‚úÖ ƒê√£ l∆∞u h·ªì s∆° & toa thu·ªëc!");
            } else {
                alert("‚ùå L·ªói khi l∆∞u h·ªì s∆°!");
            }
            closeModal(); 
            // T·∫£i l·∫°i l·ªãch kh√°m cho ng√†y ƒëang ƒë∆∞·ª£c l·ªçc
            loadSchedule(document.getElementById("filterDate").value); 
        }

        function closeModal(){ patientModal.style.display="none"; }

        // === H·ªì s∆° b√°c sƒ© ===
        function toggleEdit(enable){
            document.querySelectorAll("#hosoTable input").forEach(i=>i.readOnly=!enable);
            editBtn.style.display = enable ? "none":"inline-block";
            saveBtn.style.display = enable ? "inline-block":"none";
            cancelBtn.style.display = enable ? "inline-block":"none";
            // N·∫øu H·ªßy, t·∫£i l·∫°i profile ƒë·ªÉ kh√¥i ph·ª•c gi√° tr·ªã ban ƒë·∫ßu
            if (!enable) loadProfile(); 
        }

        async function saveDoctorProfile(){
            const body = {
                id_bacsi, // S·ª≠ d·ª•ng id_bacsi t·ª´ localStorage
                ho_ten:hosoName.value, hoc_vi:hosoHocVi.value,
                chuc_vu:hosoChucVu.value, chuyen_mon:hosoChuyenMon.value,
                nam_kinh_nghiem:hosoExp.value, email:hosoEmail.value,
                phone:hosoPhone.value, diachi:hosoAddress.value
            };
            const res = await fetch("http://localhost:3000/api/DoctorDHST/update",{
                method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)
            });
            if(res.ok) {
                alert("‚úÖ H·ªì s∆° ƒë√£ c·∫≠p nh·∫≠t!"); 
                loadProfile(); // C·∫≠p nh·∫≠t l·∫°i t√™n ·ªü sidebar
            } else {
                 alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°!"); 
            }
            toggleEdit(false);
        }

        // === Th·ªëng k√™ ===
        async function loadThongKe(){
            const { data } = await safeFetch(`http://localhost:3000/api/thongke/today?id_bacsi=${id_bacsi}`);
            if (!data) return thongkeData.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.";
            thongkeData.innerHTML = `
                S·ªë b·ªánh nh√¢n h√¥m nay: <b>${data.so_benh_nhan || 0}</b><br>
                Ca ƒë√£ kh√°m: <b>${data.da_kham || 0}</b>`;
        }

        function showSection(id,el){
            document.querySelectorAll(".section").forEach(s=>s.style.display="none");
            document.getElementById(id).style.display="block";
            document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
            el.classList.add("active");
            if(id==="thongke") loadThongKe();
        }

        function logout(){
            // X√≥a t·∫•t c·∫£ th√¥ng tin ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u
            localStorage.removeItem('user');
            localStorage.removeItem('role');
            localStorage.removeItem('doctorId'); 
            alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href="http://localhost:3000/login.html"; 
        }

        // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu khi trang ƒë∆∞·ª£c t·∫£i
        window.onload=()=>{ loadProfile(); loadSchedule(); };
    </script>
</body>
</html>
