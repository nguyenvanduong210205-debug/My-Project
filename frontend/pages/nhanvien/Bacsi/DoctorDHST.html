<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn b√°c sƒ© - Healthcare</title>
    <style>
        /* CSS Styling */
        :root {
            --blue: #007bff;
            --blue-dark: #0056b3;
            --bg: #f0f8ff;
            --card: #ffffff;
            --muted: #666;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: #333;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        aside {
            width: 260px;
            background: var(--card);
            border-right: 1px solid #d9e2ec;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        }

        .logo {
            text-align: center;
            margin-bottom: 18px;
        }

        .logo img {
            width: 120px;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #e8f3ff;
        }

        .doctor-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--blue);
        }

        .doctor-info .name {
            font-weight: 600;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        nav a {
            display: block;
            padding: 10px 12px;
            border-radius: 6px;
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }

        nav a.active,
        nav a:hover {
            background: var(--blue);
            color: #fff;
        }

        main {
            flex: 1;
            padding: 25px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            color: #004b91;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        thead th {
            background: #e6f2ff;
            color: #004b91;
            padding: 10px;
            text-align: left;
        }

        tbody td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        tbody tr:hover {
            background: #f9fbff;
        }

        .status {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
            text-transform: capitalize;
        }

        .status.cho_xac_nhan {
            background: #fff3cd;
            color: #856404;
        }

        .status.da_kham {
            background: #d4edda;
            color: #155724;
        }

        .status.huy {
            background: #f8d7da;
            color: #721c24;
        }

        .muted {
            color: #666;
            font-size: 14px;
        }

        .filter {
            margin: 10px 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter input {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .btn-primary {
            background: var(--blue);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--blue-dark);
        }

        a.name-link {
            color: var(--blue);
            text-decoration: underline;
            cursor: pointer;
        }

        /* === Modal === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 650px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 22px;
            cursor: pointer;
        }

        /* Modal Form Style */
        #patientForm label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        #patientForm textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="layout">
        <aside>
            <div>
                <div class="logo"><img src="logo.jpg" alt="logo"></div>
                <div class="doctor-info">
                    <img id="doctorAvatar" src="https://cdn-icons-png.flaticon.com/512/9131/9131529.png" alt="avatar">
                    <div>
                        <div class="name" id="doctorName"></div>
                        <div class="muted" id="doctorKhoa"></div>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a class="active" onclick="showSection('lich', this)">üìÖ L·ªãch & B·ªánh nh√¢n</a></li>
                        <li><a onclick="showSection('hoso', this)">ü©∫ H·ªì s∆°</a></li>
                        <li><a onclick="showSection('thongke', this)">üìä Th·ªëng k√™</a></li>
                    </ul>
                </nav>
            </div>
            <div class="muted" style="font-size:14px">
                Ca tr·ª±c: <b id="doctorCa">S√°ng</b><br>
                <button class="btn-primary" style="margin-top:10px" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </aside>

        <main>
            <header>
                <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn b√°c sƒ©</h1>
                <div class="muted" id="doctorGreeting"></div>
            </header>

            <section id="lich" class="section">
                <h3>üìÖ L·ªãch & Danh s√°ch b·ªánh nh√¢n</h3>
                <div class="filter">
                    <label for="filterDate">L·ªçc theo ng√†y kh√°m:</label>
                    <input type="date" id="filterDate" onchange="loadSchedule(this.value)">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ BN</th>
                            <th>T√™n b·ªánh nh√¢n</th>
                            <th>Ng√†y kh√°m</th>
                            <th>Gi·ªù h·∫πn</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="lichTableBody">
                        <tr>
                            <td colspan="6" class="muted">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="hoso" class="section" style="display:none">
                <h3>ü©∫ H·ªì s∆° b√°c sƒ©</h3>
                <div style="text-align:right; margin-bottom:10px;">
                    <button class="btn-primary" id="editBtn" onclick="toggleEdit(true)">‚úèÔ∏è Ch·ªânh s·ª≠a h·ªì s∆°</button>
                    <button class="btn-primary" id="saveBtn" style="display:none;" onclick="saveDoctorProfile()">üíæ
                        L∆∞u</button>
                    <button class="btn-primary" id="cancelBtn" style="display:none; background:#ccc; color:#000;"
                        onclick="toggleEdit(false)">‚ùå H·ªßy</button>
                </div>
                <table id="hosoTable">
                    <tbody>
                        <tr>
                            <td><b>H·ªç t√™n:</b></td>
                            <td><input id="hosoName" readonly></td>
                        </tr>
                        <tr>
                            <td><b>H·ªçc v·ªã:</b></td>
                            <td><input id="hosoHocVi" readonly></td>
                        </tr>
                        <tr>
                            <td><b>Chuy√™n m√¥n:</b></td>
                            <td><input id="hosoChuyenMon" readonly></td>
                        </tr>
                        <tr>
                            <td><b>Kinh nghi·ªám (nƒÉm):</b></td>
                            <td><input id="hosoExp" readonly></td>
                        </tr>
                        <tr>
                            <td><b>Email:</b></td>
                            <td><input id="hosoEmail" readonly></td>
                        </tr>
                        <tr>
                            <td><b>ƒêi·ªán tho·∫°i:</b></td>
                            <td><input id="hosoPhone" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="thongke" class="section" style="display:none">
                <h3>üìä Th·ªëng k√™ ho·∫°t ƒë·ªông</h3>
                <div id="thongkeData" class="muted">ƒêang t·∫£i...</div>
            </section>
        </main>
    </div>

    <div class="modal" id="patientModal">
        <div class="modal-content" style="width: 900px; max-width: 95vw;">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chi ti·∫øt b·ªánh nh√¢n (<span id="patientIdHeader"></span>)</h2>
            <form id="patientForm">
                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <div>
                        <p><b>T√™n:</b> <span id="patientName"></span></p>
                        <p><b>Gi·ªõi t√≠nh:</b> <span id="patientGender"></span></p>
                        <p><b>Ng√†y sinh:</b> <span id="patientDOB"></span></p>
                    </div>
                    <div>
                        <p><b>ƒê·ªãa ch·ªâ:</b> <span id="patientAddress"></span></p>
                        <p><b>Ng√†y kh√°m:</b> <span id="appointmentDate"></span></p>
                    </div>
                </div>

                <!-- Ph·∫ßn Nh·∫≠p toa thu·ªëc -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #004b91; margin-bottom: 10px;">üíä Nh·∫≠p toa thu·ªëc</h3>
                    <table id="prescriptionTable" style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                        <thead>
                            <tr style="background: #e6f2ff;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">T√™n thu·ªëc</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Li·ªÅu l∆∞·ª£ng</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">S·ªë ng√†y</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">C√°ch d√πng</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 50px;">X√≥a
                                </th>
                            </tr>
                        </thead>
                        <tbody id="prescriptionTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                    <div style="display: flex; gap: 10px; justify-content: space-between;">
                        <button type="button" class="btn-primary" onclick="addPrescriptionRow()"
                            style="background: #28a745;">
                            ‚ûï Th√™m thu·ªëc
                        </button>
                        <button type="button" class="btn-primary" onclick="savePrescription()"
                            style="background: #007bff;">
                            üíæ L∆∞u toa
                        </button>
                    </div>
                </div>

                <!-- Ph·∫ßn C·∫≠p nh·∫≠t b·ªánh √°n -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #004b91; margin-bottom: 15px;">ü©∫ C·∫≠p nh·∫≠t b·ªánh √°n</h3>

                    <div style="margin-bottom: 15px;">
                        <label for="trieuchung"><b>Tri·ªáu ch·ª©ng:</b></label>
                        <textarea id="trieuchung" rows="3" placeholder="Nh·∫≠p tri·ªáu ch·ª©ng c·ªßa b·ªánh nh√¢n..."
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label for="chuandoan"><b>Ch·∫©n ƒëo√°n:</b></label>
                        <textarea id="chuandoan" rows="3" placeholder="Nh·∫≠p ch·∫©n ƒëo√°n..."
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label for="ketquaxetnghiem"><b>K·∫øt qu·∫£ x√©t nghi·ªám:</b></label>
                        <textarea id="ketquaxetnghiem" rows="3" placeholder="Nh·∫≠p k·∫øt qu·∫£ x√©t nghi·ªám..."
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label for="ghichu"><b>Ghi ch√∫:</b></label>
                        <textarea id="ghichu" rows="3" placeholder="Nh·∫≠p ghi ch√∫..."
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="text-align: right;">
                        <button type="button" class="btn-primary" onclick="saveMedicalRecord()"
                            style="background: #007bff;">
                            üíæ L∆∞u b·ªánh √°n
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 1. L·∫§Y ID B√ÅC Sƒ® T·ª™ LOCALSTORAGE V√Ä KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
        let id_bacsi = null;
        let currentPatientId = null;

        // L·∫•y c√°c DOM elements
        const thongkeData = document.getElementById('thongkeData');
        const doctorName = document.getElementById('doctorName');
        const doctorKhoa = document.getElementById('doctorKhoa');
        const doctorGreeting = document.getElementById('doctorGreeting');
        const hosoName = document.getElementById('hosoName');
        const hosoHocVi = document.getElementById('hosoHocVi');
        const hosoChuyenMon = document.getElementById('hosoChuyenMon');
        const hosoExp = document.getElementById('hosoExp');
        const hosoEmail = document.getElementById('hosoEmail');
        const hosoPhone = document.getElementById('hosoPhone');

        // L·∫•y id_taikhoan t·ª´ localStorage (ƒë∆∞·ª£c l∆∞u khi ƒëƒÉng nh·∫≠p)
        const userStr = localStorage.getItem('user');
        const doctorIdFromStorage = localStorage.getItem('doctorId'); // C√≥ th·ªÉ l√† id_taikhoan

        if (!userStr && !doctorIdFromStorage) {
            // N·∫øu kh√¥ng c√≥ th√¥ng tin ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng
            alert("Phi√™n l√†m vi·ªác h·∫øt h·∫°n ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            window.location.href = "http://localhost:3000/nhanvien/login.html";
        }

        // H√†m l·∫•y id_bacsi t·ª´ id_taikhoan
        async function getBacsiId() {
            try {
                let id_taikhoan = null;

                // Th·ª≠ l·∫•y t·ª´ user object tr∆∞·ªõc
                if (userStr) {
                    const user = JSON.parse(userStr);
                    id_taikhoan = user.id;
                }
                // N·∫øu kh√¥ng c√≥, th·ª≠ l·∫•y t·ª´ doctorId (c√≥ th·ªÉ l√† id_taikhoan)
                else if (doctorIdFromStorage) {
                    id_taikhoan = doctorIdFromStorage;
                }

                if (!id_taikhoan) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y id_taikhoan');
                }

                // G·ªçi API ƒë·ªÉ l·∫•y id_bacsi t·ª´ id_taikhoan
                const { data } = await safeFetch(`http://localhost:3000/api/DoctorDHST/getBacsiId?id_taikhoan=${id_taikhoan}`);

                if (!data || !data.id_bacsi) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin b√°c sƒ©');
                }

                id_bacsi = data.id_bacsi;

                // L∆∞u l·∫°i id_bacsi v√†o localStorage ƒë·ªÉ d√πng sau
                localStorage.setItem('doctorId', id_bacsi);

                return id_bacsi;
            } catch (err) {
                console.error("L·ªói khi l·∫•y id_bacsi:", err);
                alert("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin b√°c sƒ©. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                window.location.href = "http://localhost:3000/nhanvien/login.html";
                return null;
            }
        }

        async function safeFetch(url, options = {}) {
            try {
                const res = await fetch(url, options);
                if (!res || !res.ok) {
                    console.error(`HTTP error: ${res ? res.status + ' ' + res.statusText : 'No response'}`);
                    return { data: null };
                }
                const json = await res.json();
                return json;
            } catch (err) {
                console.error("Fetch error:", err);
                return { data: null };
            }
        }


        // === H·ªì s∆° b√°c sƒ© ===
        async function loadProfile() {
            if (!id_bacsi) {
                console.error("id_bacsi ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o");
                return;
            }

            console.log("Loading profile for id_bacsi:", id_bacsi);
            const { data } = await safeFetch(`http://localhost:3000/api/DoctorDHST/doctorProfile?id_bacsi=${id_bacsi}`);

            if (!data) {
                console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu profile");
                return;
            }

            console.log("Profile data received:", data);

            // C·∫≠p nh·∫≠t th√¥ng tin tr√™n Sidebar
            if (doctorName) doctorName.textContent = data.ho_ten || 'Ch∆∞a c·∫≠p nh·∫≠t';
            if (doctorKhoa) doctorKhoa.textContent = data.ten_khoa || 'Ch∆∞a ph√¢n khoa';
            if (doctorGreeting) doctorGreeting.textContent = `Xin ch√†o, ${data.ho_ten || 'B√°c sƒ©'}`;

            // C·∫≠p nh·∫≠t th√¥ng tin trong H·ªì s∆°
            if (hosoName) hosoName.value = data.ho_ten || '';
            if (hosoHocVi) hosoHocVi.value = data.hoc_vi || '';
            if (hosoChuyenMon) hosoChuyenMon.value = data.chuyen_mon || '';
            if (hosoExp) hosoExp.value = data.nam_kinh_nghiem || '';
            if (hosoEmail) hosoEmail.value = data.email || '';
            if (hosoPhone) hosoPhone.value = data.phone || '';
        }

        // === L·ªãch kh√°m ===
        async function loadSchedule(date = "") {
            const tbody = document.getElementById("lichTableBody");
            tbody.innerHTML = `<tr><td colspan="6" class="muted">ƒêang t·∫£i...</td></tr>`;
            const url = date
                ? `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}&ngay=${date}`
                : `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}`;
            const { data } = await safeFetch(url);
            tbody.innerHTML = "";
            if (!data || !data.length) return tbody.innerHTML = `<tr><td colspan="6" class="muted">Kh√¥ng c√≥ l·ªãch kh√°m</td></tr>`;

            data.forEach((bn, i) => {
                const tr = document.createElement("tr");
                // Th√™m replace ƒë·ªÉ x·ª≠ l√Ω t√™n tr·∫°ng th√°i c√≥ kho·∫£ng tr·∫Øng (v√≠ d·ª•: "Cho X√°c Nh·∫≠n" -> "cho_xac_nhan")
                const statusClass = bn.trang_thai.toLowerCase().replace(/ /g, '_');
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${bn.id_benhnhan}</td>
                    <td><a class="name-link" onclick="openPatient('${bn.id_benhnhan}')">${bn.ten_benhnhan}</a></td>
                    <td>${bn.ngay}</td>
                    <td>${bn.khung_gio}</td>
                    <td><span class="status ${statusClass}">${bn.trang_thai}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        let currentDatlichId = null; // L∆∞u id_datlich hi·ªán t·∫°i

        // === Qu·∫£n l√Ω toa thu·ªëc ===
        function addPrescriptionRow() {
            const tbody = document.getElementById('prescriptionTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <input type="text" class="prescription-input" placeholder="T√™n thu·ªëc" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <input type="text" class="prescription-input" placeholder="Li·ªÅu l∆∞·ª£ng" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <input type="number" class="prescription-input" placeholder="S·ªë ng√†y" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <input type="text" class="prescription-input" placeholder="C√°ch d√πng" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                </td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    <button type="button" onclick="removePrescriptionRow(this)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚ùå</button>
                </td>
            `;
            tbody.appendChild(row);
        }

        function removePrescriptionRow(btn) {
            btn.closest('tr').remove();
        }

        function getPrescriptionData() {
            const rows = document.querySelectorAll('#prescriptionTableBody tr');
            const prescriptions = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.prescription-input');
                if (inputs.length >= 4) {
                    const ten_thuoc = inputs[0].value.trim();
                    const lieu_luong = inputs[1].value.trim();
                    const so_ngay = inputs[2].value.trim();
                    const cach_dung = inputs[3].value.trim();

                    if (ten_thuoc) {
                        prescriptions.push({
                            ten_thuoc,
                            lieu_luong,
                            so_ngay,
                            cach_dung
                        });
                    }
                }
            });
            return prescriptions;
        }

        async function savePrescription() {
            // N·∫øu ch∆∞a c√≥ id_datlich, th·ª≠ t√¨m l·∫°i
            if (!currentDatlichId && currentPatientId) {
                const { data: datlichData } = await safeFetch(
                    `http://localhost:3000/api/DoctorDHST/getDatlich?id_benhnhan=${currentPatientId}&id_bacsi=${id_bacsi}`
                );
                if (datlichData && datlichData.id_datlich) {
                    currentDatlichId = datlichData.id_datlich;
                }
            }

            if (!currentDatlichId) {
                alert("‚ùå Ch∆∞a c√≥ l·ªãch kh√°m. Vui l√≤ng ƒë·∫£m b·∫£o b·ªánh nh√¢n ƒë√£ c√≥ l·ªãch h·∫πn v·ªõi b√°c sƒ© n√†y.");
                return;
            }

            const prescriptions = getPrescriptionData();
            if (prescriptions.length === 0) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt lo·∫°i thu·ªëc!");
                return;
            }

            const body = {
                id_datlich: currentDatlichId,
                id_bacsi: id_bacsi,
                id_benhnhan: currentPatientId,
                toa_thuoc: prescriptions
            };

            try {
                const res = await fetch("http://localhost:3000/api/DoctorDHST/save_toa", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert("‚úÖ ƒê√£ l∆∞u toa thu·ªëc th√†nh c√¥ng!");
                    // T·∫£i l·∫°i l·ªãch kh√°m
                    const filterDate = document.getElementById("filterDate").value;
                    loadSchedule(filterDate);
                    // ƒê√≥ng modal v√† m·ªü l·∫°i ƒë·ªÉ xem d·ªØ li·ªáu ƒë√£ l∆∞u
                    closeModal();
                    // M·ªü l·∫°i modal sau 300ms ƒë·ªÉ load d·ªØ li·ªáu m·ªõi
                    setTimeout(() => {
                        openPatient(currentPatientId);
                    }, 300);
                } else {
                    const error = await res.json();
                    alert("‚ùå L·ªói khi l∆∞u toa thu·ªëc: " + (error.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error saving prescription:", err);
                alert("‚ùå L·ªói khi l∆∞u toa thu·ªëc!");
            }
        }

        async function saveMedicalRecord() {
            // N·∫øu ch∆∞a c√≥ id_datlich, th·ª≠ t√¨m l·∫°i
            if (!currentDatlichId && currentPatientId) {
                const { data: datlichData } = await safeFetch(
                    `http://localhost:3000/api/DoctorDHST/getDatlich?id_benhnhan=${currentPatientId}&id_bacsi=${id_bacsi}`
                );
                if (datlichData && datlichData.id_datlich) {
                    currentDatlichId = datlichData.id_datlich;
                }
            }

            if (!currentDatlichId) {
                alert("‚ùå Ch∆∞a c√≥ l·ªãch kh√°m. Vui l√≤ng ƒë·∫£m b·∫£o b·ªánh nh√¢n ƒë√£ c√≥ l·ªãch h·∫πn v·ªõi b√°c sƒ© n√†y.");
                return;
            }

            const body = {
                id_datlich: currentDatlichId,
                id_bacsi: id_bacsi,
                id_benhnhan: currentPatientId,
                trieu_chung: document.getElementById('trieuchung').value.trim(),
                chuan_doan: document.getElementById('chuandoan').value.trim(),
                ghi_chu: document.getElementById('ghichu').value.trim()
            };

            try {
                const res = await fetch("http://localhost:3000/api/DoctorDHST/save_benhan", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert("‚úÖ ƒê√£ l∆∞u b·ªánh √°n th√†nh c√¥ng!");
                    // T·∫£i l·∫°i l·ªãch kh√°m
                    const filterDate = document.getElementById("filterDate").value;
                    loadSchedule(filterDate);
                    // ƒê√≥ng modal v√† m·ªü l·∫°i ƒë·ªÉ xem d·ªØ li·ªáu ƒë√£ l∆∞u
                    closeModal();
                    // M·ªü l·∫°i modal sau 300ms ƒë·ªÉ load d·ªØ li·ªáu m·ªõi
                    setTimeout(() => {
                        openPatient(currentPatientId);
                    }, 300);
                } else {
                    const error = await res.json();
                    alert("‚ùå L·ªói khi l∆∞u b·ªánh √°n: " + (error.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error saving medical record:", err);
                alert("‚ùå L·ªói khi l∆∞u b·ªánh √°n!");
            }
        }

        // === Chi ti·∫øt b·ªánh nh√¢n ===
        async function openPatient(idBN) {
            if (idBN === 'N/A') {
                alert('B·ªánh nh√¢n ch∆∞a c√≥ th√¥ng tin trong h·ªá th·ªëng');
                return;
            }
            currentPatientId = idBN;
            currentDatlichId = null;

            // L·∫•y th√¥ng tin b·ªánh nh√¢n
            const { data: patientData } = await safeFetch(`http://localhost:3000/api/patient/detail?id_benhnhan=${idBN}`);
            if (!patientData) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin b·ªánh nh√¢n');
                return;
            }

            // ƒêi·ªÅn th√¥ng tin b·ªánh nh√¢n
            document.getElementById('patientIdHeader').textContent = patientData.id_benhnhan || 'N/A';
            document.getElementById('patientName').textContent = patientData.ho_ten || 'Ch∆∞a c√≥';
            document.getElementById('patientGender').textContent = patientData.gioi_tinh || 'Ch∆∞a c√≥';
            document.getElementById('patientDOB').textContent = patientData.ngay_sinh
                ? new Date(patientData.ngay_sinh).toLocaleDateString('vi-VN')
                : 'Ch∆∞a c√≥';
            document.getElementById('patientAddress').textContent = patientData.dia_chi || 'Ch∆∞a c√≥';

            // T√¨m id_datlich t·ª´ t·∫•t c·∫£ l·ªãch h·∫πn c·ªßa b·ªánh nh√¢n v·ªõi b√°c sƒ© n√†y (kh√¥ng ch·ªâ trong schedule hi·ªán t·∫°i)
            const { data: datlichData } = await safeFetch(
                `http://localhost:3000/api/DoctorDHST/getDatlich?id_benhnhan=${idBN}&id_bacsi=${id_bacsi}`
            );

            // N·∫øu kh√¥ng t√¨m th·∫•y t·ª´ API, th·ª≠ t√¨m t·ª´ schedule hi·ªán t·∫°i
            let currentAppointment = null;
            if (datlichData && datlichData.id_datlich) {
                currentAppointment = {
                    id_datlich: datlichData.id_datlich,
                    ngay: datlichData.ngay_dat,
                    khung_gio: datlichData.gio_dat ? datlichData.gio_dat.substring(0, 5) : '',
                    trang_thai: datlichData.trang_thai
                };
            } else {
                // Fallback: t√¨m t·ª´ schedule hi·ªán t·∫°i
                const filterDate = document.getElementById("filterDate").value;
                const scheduleUrl = filterDate
                    ? `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}&ngay=${filterDate}`
                    : `http://localhost:3000/api/DoctorDHST/schedule?id_bacsi=${id_bacsi}`;

                const scheduleRes = await safeFetch(scheduleUrl);
                // So s√°nh c·∫£ string v√† number ƒë·ªÉ ƒë·∫£m b·∫£o t√¨m th·∫•y
                currentAppointment = scheduleRes.data?.find(apt =>
                    apt.id_benhnhan == idBN || String(apt.id_benhnhan) === String(idBN)
                );
            }

            // ƒêi·ªÅn th√¥ng tin l·ªãch kh√°m
            if (currentAppointment && currentAppointment.id_datlich) {
                currentDatlichId = currentAppointment.id_datlich;
                document.getElementById('appointmentDate').textContent = currentAppointment.ngay
                    ? new Date(currentAppointment.ngay).toLocaleDateString('vi-VN')
                    : 'Ch∆∞a c√≥';

                // L·∫•y th√¥ng tin h·ªì s∆° kh√°m b·ªánh n·∫øu c√≥
                const { data: recordData } = await safeFetch(
                    `http://localhost:3000/api/DoctorDHST/full_detail?id_datlich=${currentAppointment.id_datlich}`
                );

                if (recordData && recordData.medicalRecord) {
                    document.getElementById('trieuchung').value = recordData.medicalRecord.trieu_chung || '';
                    document.getElementById('chuandoan').value = recordData.medicalRecord.chuan_doan || '';
                    document.getElementById('ghichu').value = recordData.medicalRecord.ghi_chu || '';
                }

                // Load toa thu·ªëc n·∫øu c√≥
                if (recordData && recordData.prescription && recordData.prescription.toa_thuoc) {
                    const prescription = recordData.prescription.toa_thuoc;
                    const tbody = document.getElementById('prescriptionTableBody');
                    tbody.innerHTML = '';

                    if (prescription.length > 0 && prescription[0].thuoc_ke_don) {
                        // Parse thuoc_ke_don (d·∫°ng text) th√†nh c√°c h√†ng
                        const thuocText = prescription[0].thuoc_ke_don;
                        const lines = thuocText.split('\n').filter(line => line.trim());

                        lines.forEach(line => {
                            // Parse format: "T√™n thu·ªëc - Li·ªÅu l∆∞·ª£ng: ... - ... ng√†y - C√°ch d√πng: ..."
                            const parts = line.split(' - ');
                            const ten_thuoc = parts[0] || '';
                            const lieu_luong = parts[1]?.replace('Li·ªÅu l∆∞·ª£ng: ', '') || '';
                            const so_ngay = parts[2]?.replace(' ng√†y', '') || '';
                            const cach_dung = parts[3]?.replace('C√°ch d√πng: ', '') || '';

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    <input type="text" class="prescription-input" value="${ten_thuoc.replace(/"/g, '&quot;')}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    <input type="text" class="prescription-input" value="${lieu_luong.replace(/"/g, '&quot;')}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    <input type="number" class="prescription-input" value="${so_ngay}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    <input type="text" class="prescription-input" value="${cach_dung.replace(/"/g, '&quot;')}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                    <button type="button" onclick="removePrescriptionRow(this)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚ùå</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        document.getElementById('prescriptionTableBody').innerHTML = '';
                        addPrescriptionRow();
                    }
                } else {
                    document.getElementById('prescriptionTableBody').innerHTML = '';
                    addPrescriptionRow();
                }
            } else {
                document.getElementById('appointmentDate').textContent = 'Ch∆∞a c√≥ l·ªãch h·∫πn';
                // X√≥a n·ªôi dung c≈©
                document.getElementById('trieuchung').value = "";
                document.getElementById('chuandoan').value = "";
                document.getElementById('ghichu').value = "";
                document.getElementById('ketquaxetnghiem').value = "";
                document.getElementById('prescriptionTableBody').innerHTML = '';
                addPrescriptionRow();
            }

            patientModal.style.display = "flex";
        }


        function closeModal() { patientModal.style.display = "none"; }

        // === H·ªì s∆° b√°c sƒ© ===
        function toggleEdit(enable) {
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            document.querySelectorAll("#hosoTable input").forEach(i => i.readOnly = !enable);
            if (editBtn) editBtn.style.display = enable ? "none" : "inline-block";
            if (saveBtn) saveBtn.style.display = enable ? "inline-block" : "none";
            if (cancelBtn) cancelBtn.style.display = enable ? "inline-block" : "none";
            // N·∫øu H·ªßy, t·∫£i l·∫°i profile ƒë·ªÉ kh√¥i ph·ª•c gi√° tr·ªã ban ƒë·∫ßu
            if (!enable) loadProfile();
        }

        async function saveDoctorProfile() {
            if (!id_bacsi) {
                alert("‚ùå Kh√¥ng t√¨m th·∫•y ID b√°c sƒ©. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                return;
            }

            const body = {
                id_bacsi: id_bacsi, // S·ª≠ d·ª•ng id_bacsi t·ª´ localStorage
                ho_ten: hosoName.value.trim(),
                hoc_vi: hosoHocVi.value.trim(),
                chuyen_mon: hosoChuyenMon.value.trim(),
                nam_kinh_nghiem: hosoExp.value ? parseInt(hosoExp.value) : null,
                email: hosoEmail.value.trim(),
                phone: hosoPhone.value.trim()
                // B·ªè chuc_vu v√† diachi v√¨ kh√¥ng c√≥ trong schema
            };

            // Validation
            if (!body.ho_ten) {
                alert("‚ùå Vui l√≤ng nh·∫≠p h·ªç t√™n!");
                return;
            }

            try {
                const res = await fetch("http://localhost:3000/api/DoctorDHST/update", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const result = await res.json();

                if (res.ok) {
                    alert("‚úÖ H·ªì s∆° ƒë√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    loadProfile(); // C·∫≠p nh·∫≠t l·∫°i t√™n ·ªü sidebar
                    toggleEdit(false);
                } else {
                    const errorMsg = result.error || result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
                    alert(`‚ùå L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°: ${errorMsg}`);
                    console.error("Error response:", result);
                }
            } catch (err) {
                console.error("Error saving profile:", err);
                alert("‚ùå L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t h·ªì s∆°!");
            }
        }

        // === Th·ªëng k√™ ===
        async function loadThongKe() {
            if (!thongkeData) return;
            thongkeData.textContent = "ƒêang t·∫£i...";

            const { data } = await safeFetch(`http://localhost:3000/api/DoctorDHST/thongke/today?id_bacsi=${id_bacsi}`);

            if (!data) {
                thongkeData.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.";
                return;
            }

            const soBenhNhan = data.so_benh_nhan || 0;
            const daKham = data.da_kham || 0;
            const choKham = soBenhNhan - daKham;

            thongkeData.innerHTML = `
                <div style="padding: 15px; background: #f0f8ff; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 8px 0; font-size: 16px;">
                        üìã <strong>S·ªë b·ªánh nh√¢n h√¥m nay:</strong> <span style="color: #004b91; font-size: 18px; font-weight: bold;">${soBenhNhan}</span>
                    </p>
                    <p style="margin: 8px 0; font-size: 16px;">
                        ‚úÖ <strong>Ca ƒë√£ kh√°m:</strong> <span style="color: #28a745; font-size: 18px; font-weight: bold;">${daKham}</span>
                    </p>
                    <p style="margin: 8px 0; font-size: 16px;">
                        ‚è≥ <strong>Ca ch·ªù kh√°m:</strong> <span style="color: #ffc107; font-size: 18px; font-weight: bold;">${choKham}</span>
                    </p>
                </div>`;
        }

        function showSection(id, el) {
            document.querySelectorAll(".section").forEach(s => s.style.display = "none");
            document.getElementById(id).style.display = "block";
            document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
            el.classList.add("active");
            if (id === "thongke") {
                loadThongKe();
            } else if (id === "hoso") {
                // Load l·∫°i profile khi chuy·ªÉn sang tab H·ªì s∆°
                if (id_bacsi) {
                    loadProfile();
                }
            }
        }

        function logout() {
            // X√≥a t·∫•t c·∫£ th√¥ng tin ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u
            localStorage.removeItem('user');
            localStorage.removeItem('role');
            localStorage.removeItem('doctorId');
            alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href = "http://localhost:3000/login.html";
        }

        // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = async () => {
            // L·∫•y id_bacsi tr∆∞·ªõc khi load d·ªØ li·ªáu
            await getBacsiId();
            if (id_bacsi) {
                loadProfile();
                loadSchedule();
            }
        };
    </script>
</body>

</html>