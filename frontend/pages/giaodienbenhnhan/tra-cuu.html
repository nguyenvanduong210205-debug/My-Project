<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u k·∫øt qu·∫£ kh√°m - DHST Healthcare</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/*===== PH·∫¶N T·ªîNG QUAN V√Ä M√ÄU S·∫ÆC CH·ª¶ ƒê·∫†O =====*/
* {margin:0; padding:0; box-sizing:border-box; font-family:"Montserrat",sans-serif;}
body {background:#f4f7f9; color:#333; line-height:1.6;}
a {text-decoration: none; color: inherit;}
ul {list-style: none;}

:root {
--primary-color: #0A66C2; 
--primary-light: #4285F4; 
--primary-dark: #074a8d; 
--accent-color: #FFD700; 
--text-color: #4a4a4a;
--bg-light: #ffffff;
--bg-grey-soft: #e8f4ff; 
}

/*===== HEADER NGH·ªÜ THU·∫¨T =====*/
.main-header {
position: sticky;
top: 0;
z-index: 1000;
background: var(--bg-light);
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 60px; 
border-bottom: 1px solid #e0e0e0;
}
.logo {
display: flex;
align-items: center;
gap: 15px;
}
.logo img {
border-radius: 50%;
border: 4px solid var(--primary-color);
width: 60px;
height: 60px;
object-fit: cover;
box-shadow: 0 0 10px rgba(0, 102, 194, 0.3);
}
.logo-title-group {
text-align: left;
}
.logo-title {
font-family: 'Oswald', sans-serif;
font-size: 28px;
font-weight: 700;
color: var(--primary-dark);
line-height: 1;
text-transform: uppercase;
letter-spacing: 1px;
}
.hospital-slogan {
font-style: normal;
font-size: 16px;
font-weight: 500;
color: var(--primary-light);
margin-top: 5px;
}
.call-to-action {
background: var(--primary-color);
color: white;
padding: 10px 20px;
border-radius: 25px;
font-weight: 600;
display: flex;
align-items: center;
gap: 10px;
transition: background 0.3s, transform 0.3s;
}
.call-to-action:hover {
background: var(--primary-dark);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0, 102, 194, 0.4);
}
.main-nav-bar {
background: var(--primary-color);
padding: 0 60px;
min-height: 65px;
display: flex;
justify-content: space-between;
align-items: center;
}
.nav-links {
display: flex;
gap: 0;
}
.nav-item {
position: relative;
padding: 0 20px;
height: 65px;
display: flex;
align-items: center;
font-weight: 600;
color: white;
transition: background 0.3s, color 0.3s, transform 0.3s;
text-transform: uppercase;
letter-spacing: 0.5px;
text-align:center;
}
.nav-item:hover, .nav-item.active {
background: var(--primary-light);
color: white;
transform: translateY(-2px);
border-bottom: 3px solid var(--accent-color);
}
.nav-item.active {
background: var(--primary-dark);
color: var(--accent-color);
border-bottom: 3px solid var(--accent-color);
}
.search-bar {
display: flex;
align-items: center;
border: 1px solid rgba(255,255,255,0.4);
border-radius: 20px;
overflow: hidden;
background: rgba(255,255,255,0.2);
}
.search-bar input {
padding: 8px 12px;
border: none;
outline: none;
width: 180px;
background: transparent;
color: white;
}
.search-bar input::placeholder {
color: rgba(255,255,255,0.7);
}
.search-bar button {
background: var(--primary-light);
color: white;
border: none;
padding: 8px 15px;
cursor: pointer;
transition: background 0.3s;
}
.search-bar button:hover {
background: var(--primary-dark);
}

/*===== TRA C·ª®U SECTION =====*/
.lookup-section {
background: var(--bg-grey-soft);
padding: 60px 20px 80px;
}
.lookup-header {
text-align: center;
margin-bottom: 50px;
}
.lookup-header h2 {
font-size: 38px;
color: var(--primary-dark);
font-weight: 700;
margin-bottom: 10px;
font-family: 'Oswald', sans-serif;
text-transform: uppercase;
}
.lookup-header p {
color: #666;
font-size: 18px;
}

.lookup-form-container {
max-width: 800px; 
margin: 0 auto;
background: var(--bg-light);
padding: 45px 50px;
border-radius: 20px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
border-top: 5px solid var(--primary-color);
}
.lookup-form-container h3 {
text-align: center;
color: var(--primary-color);
font-size: 24px;
font-weight: 700;
margin-bottom: 30px;
}

/*--- Thanh Ti·∫øn Tr√¨nh (Steps) ---*/
.progress-bar {
display: flex;
justify-content: space-between;
margin-bottom: 40px;
position: relative;
}
.progress-bar::before {
content: '';
position: absolute;
top: 50%;
left: 0;
right: 0;
height: 3px;
background: #ccc;
transform: translateY(-50%);
z-index: 1;
}
.progress-step {
z-index: 2;
text-align: center;
position: relative;
flex: 1;
}
.step-circle {
width: 40px;
height: 40px;
border-radius: 50%;
background: #ccc;
color: white;
font-weight: 700;
margin: 0 auto 10px;
transition: background 0.3s, border-color 0.3s;
border: 3px solid #ccc;
display: flex; 
justify-content: center;
align-items: center;
}
.step-text {
font-size: 14px;
color: #999;
font-weight: 600;
transition: color 0.3s;
}
.progress-step.active .step-circle {
background: var(--primary-light);
border-color: var(--primary-color);
box-shadow: 0 0 10px rgba(10, 102, 194, 0.5);
}
.progress-step.completed .step-circle {
background: #28a745;
border-color: #1e7e34;
}
.progress-step.completed .step-text {
color: #28a745;
}

/*--- N·ªôi Dung C√°c B∆∞·ªõc ---*/
.step-content {
display: none;
animation: fadeIn 0.5s;
}
.step-content.active {
display: block;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

.input-group {
display: flex;
flex-direction: column;
gap: 15px;
margin-bottom: 25px;
}
.input-group label {
font-weight: 600;
color: var(--primary-dark);
}
.input-group input {
padding: 16px 20px; 
font-size: 16px;
border-radius: 12px; 
border: 1px solid #ccc;
transition: 0.3s;
outline: none;
background: #fcfcfc;
text-align: center;
font-weight: 700;
letter-spacing: 1px;
}
.input-group input:focus {
border-color: var(--primary-color);
box-shadow: 0 0 8px rgba(10, 102, 194, 0.5);
}
.otp-message {
text-align: center;
color: #28a745;
font-weight: 600;
margin-top: -10px;
margin-bottom: 20px;
}

/*--- Danh s√°ch B·ªánh nh√¢n v√† L·∫ßn kh√°m ---*/
.patient-list, .visit-list {
margin-top: 20px;
padding: 10px;
}
.patient-item, .visit-item {
background: #f0f7ff; 
padding: 15px 20px;
margin-bottom: 10px;
border-radius: 10px;
border-left: 5px solid var(--primary-light);
cursor: pointer;
transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
display: flex;
justify-content: space-between;
align-items: center;
}
.patient-item:hover, .visit-item:hover {
background: #e0f0ff;
transform: translateX(5px);
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}
.item-info strong {
color: var(--primary-dark);
}
.item-action {
color: var(--primary-color);
font-weight: 600;
white-space: nowrap; 
}

/*--- CH·ªàNH S·ª¨A BUTTON (ƒê√£ ph·ª•c h·ªìi hi·ªáu ·ª©ng) ---*/
.btn-primary {
    background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
    color: white;
    border: none;
    padding: 16px;
    font-size: 18px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 6px 20px rgba(0, 102, 194, 0.3); /* Hi·ªáu ·ª©ng ƒë·ªï b√≥ng n·ªïi b·∫≠t */
    width: 100%;
    /* Th√™m m·ªôt ch√∫t n·ªïi 3D */
    border-bottom: 4px solid var(--primary-dark);
}
.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 102, 194, 0.5);
    background: var(--primary-dark); /* ƒê·∫£m b·∫£o m√†u hover */
    border-bottom: 1px solid var(--primary-dark); /* Gi·∫£m ƒë·ªô d√†y khi hover */
}
.btn-back {
    background: #ccc;
    margin-top: 15px;
    color: #333;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    border-bottom: 4px solid #999;
}
.btn-back:hover {
    background: #aaa;
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    border-bottom: 1px solid #999;
}

.error-message {
    color: #cc0000;
    text-align: center;
    font-weight: 600;
    margin-top: 15px;
}

/*--- Chi ti·∫øt H·ªì s∆° (T·ªïng quan) ---*/
.info-card-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}
.info-card {
    background: var(--bg-light);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-top: 3px solid var(--primary-light);
    flex: 1 1 300px;
}
.info-card h5 {
    font-size: 16px;
    color: var(--primary-dark);
    border-bottom: 2px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 10px;
    font-weight: 700;
}
.info-card p, .info-card small {
    color: var(--text-color);
    line-height: 1.5;
}
.info-card strong {
    font-weight: 600;
    color: #000;
}

/*--- Chi ti·∫øt H·ªì s∆° (B∆∞·ªõc 5) - B·ªë c·ª•c 2 c·ªôt ch√≠nh ---*/
.visit-detail-layout {
    display: flex;
    gap: 20px;
}
.main-details {
    flex: 2;
}
.side-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.side-card {
    padding: 0; 
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid #ddd;
    overflow: hidden;
}

/*--- CSS cho Th·∫ª n·ªïi b·∫≠t (Stunning Card) ---*/
.stunning-card {
    padding: 0;
    border: 1px solid #ddd;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}
.stunning-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}
.card-header-stunning {
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: 'Oswald', sans-serif;
}
.card-header-stunning h5 {
    color: white; 
    font-size: 18px;
    margin: 0;
    padding: 0;
    border-bottom: none;
}
.card-header-stunning i {
    font-size: 24px;
}
.card-content-stunning {
    padding: 20px;
    background: #ffffff;
}

/*--- CSS cho B·ªë c·ª•c 4 c·ªôt ƒë∆°n gi·∫£n (·∫¢nh m·∫´u) ---*/
.main-details-simple {
    background: #ffffff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-top: 3px solid #CC0000;
    margin-bottom: 20px;
}
.simple-detail-row {
    display: inline-block;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 15px;
    margin-bottom: 0;
    gap: 15px;
}
.simple-detail-col {
    flex: 1; 
    padding: 0 10px;
}
.simple-detail-col:first-child {
    padding-left: 0;
}
.simple-detail-col:last-child {
    padding-right: 0;
}
.simple-detail-col strong {
    font-size: 16px; 
    color: var(--primary-dark);
    margin-bottom: 5px;
    display: inline-block;
    font-weight: 700;
}
.simple-detail-col p {
    font-size: 15px;
    color: #000;
    line-height: 1.4;
    font-weight: 500;
}

/*--- B·∫£ng ƒê∆°n thu·ªëc ---*/
.medication-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 15px;
}

.medication-table th,
.medication-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}

.medication-table th {
  background: #e8f5f3;
  color: #006a5b;
  font-weight: 600;
}

.medication-table tr:nth-child(even) {
  background: #fafafa;
}

/*--- FOOTER & RESPONSIVE ---*/
.main-footer {
background: var(--primary-dark);
color: white;
text-align: center;
padding: 20px 0;
margin-top: 0;
}

@media (max-width: 768px) {
.top-bar {flex-direction: column; gap: 10px; padding: 10px 20px;}
.call-to-action {display: none;}
.main-nav-bar {flex-direction: column; padding: 10px 20px; min-height: auto;}
.nav-links {flex-wrap: wrap; justify-content: center; gap: 5px; width: 100%;}
.nav-item {padding: 8px 10px; height: auto; font-size: 14px;}
.search-bar {margin-top: 15px; width: 100%;}
.lookup-header h2 {font-size: 30px;}
.lookup-form-container {padding: 30px 20px;}
.visit-detail-layout {flex-direction: column;}
.simple-detail-row {flex-direction: column; gap: 5px;}
.simple-detail-col {padding: 0;}
}
</style>
</head>

<body>

<header class="main-header">
<div class="top-bar">
<div class="logo">
<img src="logo.jpg" alt="DHST Healthcare Logo"> 
<div class="logo-title-group">
<div class="logo-title">DHST Healthcare</div>
<div class="hospital-slogan">Y H·ªçc Ti√™n Ti·∫øn - ChƒÉm S√≥c T·∫≠n T√¢m</div>
</div>
</div>
<a href="tel:19001234" class="call-to-action">
<i class="fas fa-phone-alt"></i>
T·ªïng ƒë√†i H·ªó tr·ª£: 1900.1234
</a>
</div>

<nav class="main-nav-bar">
<ul class="nav-links">
<li><a href="index.html" class="nav-item ">Trang ch·ªß</a></li>
<li><a href="tin-tuc.html" class="nav-item">Tin t·ª©c & B√†i vi·∫øt</a></li>
<li><a href="dich-vu.html" class="nav-item">D·ªãch v·ª•</a></li>
<li><a href="bac-si.html" class="nav-item">ƒê·ªôi ng≈© b√°c sƒ©</a></li>
<li><a href="thiet-bi.html" class="nav-item">Thi·∫øt b·ªã</a></li>
<li><a href="dat-lich.html" class="nav-item">ƒê·∫∑t l·ªãch kh√°m</a></li>
<li><a href="tra-cuu.html" class="nav-item active">Tra c·ª©u k·∫øt qu·∫£</a></li>
</ul>

</nav>
</header>

<main>
<section class="lookup-section">
<div class="lookup-header">
<h2>TRA C·ª®U H·ªí S∆† & K·∫æT QU·∫¢ KH√ÅM B·ªÜNH</h2>
<p>Quy tr√¨nh b·∫£o m·∫≠t 4 b∆∞·ªõc: Nh·∫≠p SƒêT, X√°c th·ª±c OTP, Ch·ªçn H·ªì s∆°, Xem Chi ti·∫øt.</p>
</div>

<div class="lookup-form-container">
<h3>H·ªÜ TH·ªêNG TRA C·ª®U B·∫¢O M·∫¨T</h3>

<div class="progress-bar">
<div id="step1" class="progress-step active">
<div class="step-circle"><i class="fas fa-mobile-alt"></i></div>
<div class="step-text">Nh·∫≠p SƒêT</div>
</div>
<div id="step2" class="progress-step">
<div class="step-circle"><i class="fas fa-lock"></i></div>
<div class="step-text">X√°c th·ª±c OTP</div>
</div>
<div id="step3" class="progress-step">
<div class="step-circle"><i class="fas fa-user-check"></i></div>
<div class="step-text">Ch·ªçn H·ªì s∆°</div>
</div>
<div id="step4" class="progress-step">
<div class="step-circle"><i class="fas fa-file-medical"></i></div>
<div class="step-text">Xem K·∫øt qu·∫£</div>
</div>
</div>

<div id="lookupForm">
<div id="contentStep1" class="step-content active">
<div class="input-group">
<label for="phoneNumber">S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒëƒÉng k√Ω:</label>
<input type="tel" id="phoneNumber" placeholder="V√≠ d·ª•: 0901234567" required maxlength="10">
</div>
<p id="alertMessage" class="error-message" style="display: none;"></p>
<button id="btnRequestOtp" class="btn-primary" type="button">
<i class="fas fa-sms"></i> G·ª≠i m√£ x√°c th·ª±c OTP
</button>
</div>

<div id="contentStep2" class="step-content">
<p id="otpInfo" class="otp-message">M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn SƒêT <strong id="sentPhone"></strong>.</p>
<div class="input-group">
<label for="otpCode">Nh·∫≠p m√£ OTP (6 s·ªë):</label>
<input type="text" id="otpCode" placeholder="Nh·∫≠p m√£ 6 ch·ªØ s·ªë" required maxlength="6">
</div>
<p id="otpErrorMessage" class="error-message" style="display: none;"></p>
<button id="btnVerifyOtp" class="btn-primary" type="button">
<i class="fas fa-check-circle"></i> X√°c nh·∫≠n v√† Tra c·ª©u
</button>
<button id="btnBackToPhone" class="btn-primary btn-back" type="button">
<i class="fas fa-arrow-left"></i> Nh·∫≠p l·∫°i SƒêT
</button>
</div>

<div id="contentStep3" class="step-content">
<h4>Vui l√≤ng ch·ªçn h·ªì s∆° b·ªánh nh√¢n c·∫ßn tra c·ª©u:</h4>
<div id="patientList" class="patient-list">
</div>
</div>

<div id="contentStep4" class="step-content">
<h4 id="visitHistoryTitle">L·ªãch s·ª≠ c√°c l·∫ßn kh√°m c·ªßa B·ªánh nh√¢n:</h4>

<div class="info-card-container">
    <div class="info-card" style="flex: 1 1 45%;">
        <h5><i class="fas fa-user-circle" style="color: var(--primary-color); margin-right: 5px;"></i> Th√¥ng tin B·ªánh nh√¢n</h5>
        <p>H·ªç t√™n: <strong><span id="bnHoTen"></span></strong></p>
        <p>Ng√†y sinh: <strong><span id="bnNgaySinh"></span></strong></p>
        <p>Gi·ªõi t√≠nh: <strong><span id="bnGioiTinh"></span></strong></p>
    </div>
    <div class="info-card" style="flex: 1 1 45%;">
        <h5><i class="fas fa-id-card" style="color: var(--primary-color); margin-right: 5px;"></i> Th√¥ng tin Li√™n h·ªá & H·ªì s∆°</h5>
        <p>SƒêT: <strong><span id="bnPhone"></span></strong></p>
        <p>M√£ BHYT: <strong><span id="bnBHYT"></span></strong></p>
        <p>ID H·ªì s∆°: <strong><span id="bnID"></span></strong></p>
    </div>
</div>
<div id="visitList" class="visit-list">
</div>
<button id="btnBackToPatients" class="btn-primary btn-back" type="button">
<i class="fas fa-arrow-left"></i> Quay l·∫°i ch·ªçn H·ªì s∆°
</button>
</div>

<div id="contentStep5" class="step-content">
    <h4 id="detailTitle" style="text-align: center; margin-bottom: 25px; font-size: 26px; color: var(--primary-dark); font-family: 'Oswald', sans-serif;">CHI TI·∫æT H·ªí S∆† B·ªÜNH √ÅN</h4>

    <div id="visitDetails" class="visit-detail-layout">
        
        <div class="side-details">
            <div class="side-card stunning-card">
                <div class="card-header-stunning" style="background: var(--primary-light);">
                    <i class="fas fa-user"></i>
                    <h5>TH√îNG TIN B·ªÜNH NH√ÇN</h5>
                </div>
                <div class="card-content-stunning">
                    <p>H·ªç t√™n: <strong><span id="dtHoTen">...</span></strong></p>
                    <p>Ng√†y sinh: <strong><span id="dtNgaySinh">...</span></strong></p>
                    <p>Gi·ªõi t√≠nh: <strong><span id="dtGioiTinh">...</span></strong></p>
                    <p>SƒêT: <strong><span id="dtPhone">...</span></strong></p>
                </div>
            </div>

            <div class="side-card stunning-card">
                <div class="card-header-stunning" style="background: #f4b400;">
                    <i class="fas fa-user-md"></i>
                    <h5>B√ÅC Sƒ® ƒêI·ªÄU TR·ªä</h5>
                </div>
                <div class="card-content-stunning">
                    <p>T√™n b√°c sƒ©: <strong><span id="dtTenBS">...</span></strong></p>
                    <p>Chuy√™n khoa: <strong><span id="dtChuyenKhoa">...</span></strong></p>
                    <p>M√£ HS: <strong><span id="dtMaHoSo">...</span></strong></p>
                </div>
            </div>
        </div>
        
        <div class="main-details">
            <div class="main-details-simple">
                <div class="simple-detail-row">
                    <div class="simple-detail-col">
                        <strong>Ch·∫©n ƒëo√°n:</strong>
                        <p id="detailChanDoan">ƒêang t·∫£i...</p>
                    </div>
                    <div class="simple-detail-col">
                        <strong>Tri·ªáu ch·ª©ng:</strong>
                        <p id="detailTrieuChung">ƒêang t·∫£i...</p>
                    </div>
                    <div class="simple-detail-col">
                        <strong>Thu·ªëc k√™ ƒë∆°n:</strong>
                        <p id="detailThuocKeDonText">ƒêang t·∫£i...</p>
                    </div>
                    <div class="simple-detail-col">
                        <strong>Ghi ch√∫ c·ªßa b√°c sƒ©:</strong>
                        <p id="detailGhiChu">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>

            <div class="stunning-card">
                <div class="card-header-stunning" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <h5>ƒê∆†N THU·ªêC K√ä ƒê∆†N</h5>
                </div>
                <div class="card-content-stunning" id="medicationContent">
                    <p id="noMedication" style="text-align: center; color: #999; display: none;">Kh√¥ng c√≥ thu·ªëc ƒë∆∞·ª£c k√™ ƒë∆°n trong l·∫ßn kh√°m n√†y.</p>
                    <table class="medication-table" id="medicationTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>T√™n thu·ªëc</th>
                                <th>Li·ªÅu l∆∞·ª£ng</th>
                                <th>C√°ch d√πng</th>
                                <th>Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody id="medicationBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <button id="btnDownload" class="btn-primary" style="margin-top: 30px;" type="button">
        <i class="fas fa-file-pdf"></i> T·∫£i H·ªì s∆° Kh√°m b·ªánh (PDF)
    </button>
    <button id="btnBackToVisits" class="btn-primary btn-back" type="button">
        <i class="fas fa-arrow-left"></i> Quay l·∫°i L·ªãch s·ª≠ kh√°m
    </button>
</div>

</div>
</section>
</main>

<footer class="main-footer">
<p>¬© 2025 DHST Healthcare | Li√™n h·ªá T·ªïng ƒë√†i: 1900.888.666</p>
</footer>

<script>
//=======================================================
//JS LOGIC CHO GIAO DI·ªÜN ƒêA B∆Ø·ªöC V√Ä G·ªåI API TH·ª∞C T·∫æ
//=======================================================

// Thi·∫øt l·∫≠p URL g·ªëc c·ªßa Backend API (Thay ƒë·ªïi n·∫øu c·ªïng c·ªßa b·∫°n kh√°c)
const API_BASE_URL = 'http://localhost:3000/api/patient'; 

//--- Bi·∫øn Tr·∫°ng Th√°i---
let currentStep = 1;
let currentPhoneNumber = '';
let currentPatients = []; 
let selectedPatientData = {}; // L∆∞u to√†n b·ªô data c·ªßa b·ªánh nh√¢n ƒë∆∞·ª£c ch·ªçn

//--- DOM Elements---
const stepContents = [
document.getElementById('contentStep1'),
document.getElementById('contentStep2'),
document.getElementById('contentStep3'),
document.getElementById('contentStep4'),
document.getElementById('contentStep5'),
];
const steps = [
document.getElementById('step1'),
document.getElementById('step2'),
document.getElementById('step3'),
document.getElementById('step4'),
];
const phoneInput = document.getElementById('phoneNumber');
const otpInput = document.getElementById('otpCode');
const alertMessage = document.getElementById('alertMessage');
const otpErrorMessage = document.getElementById('otpErrorMessage');
const patientListDiv = document.getElementById('patientList');
const visitListDiv = document.getElementById('visitList');
const visitDetailsDiv = document.getElementById('visitDetails');

// --- H√†m ti·ªán √≠ch ƒë·ªãnh d·∫°ng ng√†y th√°ng ---
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    // C·∫Øt b·ªè ph·∫ßn T v√† Z n·∫øu l√† ƒë·ªãnh d·∫°ng ISO (v√≠ d·ª•: 2025-10-04T22:00:00.000Z)
    if (dateString.includes('T')) {
        return dateString.substring(0, 10).split('-').reverse().join('/'); // Chuy·ªÉn sang DD/MM/YYYY
    }
    return dateString; // Tr·∫£ v·ªÅ nguy√™n n·∫øu ƒë√£ l√† ƒë·ªãnh d·∫°ng Date thu·∫ßn
}

//--- H√†m hi·ªÉn th·ªã/·∫©n th√¥ng b√°o l·ªói---
function displayError(element, message) {
element.textContent = message;
element.style.display = 'block';
}

function hideError(element) {
element.textContent = '';
element.style.display = 'none';
}

//--- H√†m chuy·ªÉn b∆∞·ªõc---
function goToStep(stepIndex) {
if (stepIndex < 1 || stepIndex > 5) return;

currentStep = stepIndex;

//C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
steps.forEach((step, index) => {
step.classList.remove('active', 'completed');

if (index + 1 < stepIndex) {
step.classList.add('completed');
} 

if (index + 1 === stepIndex) {
step.classList.add('active');
}

//B∆∞·ªõc cu·ªëi c√πng (step 4) bao g·ªìm c·∫£ content 4 v√† 5
if (index + 1 === 4 && stepIndex >= 4) {
step.classList.add('active');
if(stepIndex > 4) step.classList.add('completed');
else step.classList.remove('completed');
}
});

//Hi·ªán n·ªôi dung b∆∞·ªõc
stepContents.forEach((content, index) => {
content.classList.remove('active');
if (index + 1 === stepIndex) {
content.classList.add('active');
}
});

//Cu·ªôn l√™n ƒë·∫ßu form
document.getElementById('lookupForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

//--- B∆∞·ªõc 1: Y√™u c·∫ßu OTP (POST /api/patient/search/request-otp)---
document.getElementById('btnRequestOtp').addEventListener('click', async () => {
const phoneNumber = phoneInput.value.trim();
hideError(alertMessage);

if (phoneNumber.length !== 10 || !/^\d{10}$/.test(phoneNumber)) {
displayError(alertMessage, 'Vui l√≤ng nh·∫≠p 10 ch·ªØ s·ªë h·ª£p l·ªá cho SƒêT.');
return;
}

currentPhoneNumber = phoneNumber;

try {
const response = await fetch(`${API_BASE_URL}/search/request-otp`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ phoneNumber: currentPhoneNumber })
});

const data = await response.json();

if (response.ok) {
document.getElementById('sentPhone').textContent = currentPhoneNumber;
otpInput.value = ''; 
alertMessage.textContent = data.message || 'M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng.';
hideError(alertMessage);
goToStep(2);
} else {
displayError(alertMessage, data.message || 'L·ªói: Kh√¥ng t√¨m th·∫•y h·ªì s∆° ho·∫∑c kh√¥ng th·ªÉ g·ª≠i OTP.');
}

} catch (error) {
displayError(alertMessage, 'L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i sau.');
console.error('L·ªói khi g·ª≠i OTP:', error);
}
});

//--- B∆∞·ªõc 2: X√°c th·ª±c OTP (POST /api/patient/search/verify-otp)---
document.getElementById('btnVerifyOtp').addEventListener('click', async () => {
const otp = otpInput.value.trim();
hideError(otpErrorMessage);

if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
displayError(otpErrorMessage, 'M√£ OTP ph·∫£i l√† 6 ch·ªØ s·ªë.');
return;
}

try {
const response = await fetch(`${API_BASE_URL}/search/verify-otp`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ phoneNumber: currentPhoneNumber, otp: otp })
});

const data = await response.json();

if (response.ok && data.patients && data.patients.length > 0) {
currentPatients = data.patients; 

if (currentPatients.length === 1) {
// 1 h·ªì s∆°: Chuy·ªÉn th·∫≥ng t·ªõi danh s√°ch l·∫ßn kh√°m (B∆∞·ªõc 4)
selectPatient(currentPatients[0]); // Truy·ªÅn to√†n b·ªô ƒë·ªëi t∆∞·ª£ng
} else {
// Nhi·ªÅu h·ªì s∆°: Chuy·ªÉn t·ªõi b∆∞·ªõc ch·ªçn b·ªánh nh√¢n (B∆∞·ªõc 3)
renderPatientList(currentPatients);
goToStep(3);
}
} else {
displayError(otpErrorMessage, data.message || 'M√£ OTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.');
}

} catch (error) {
displayError(otpErrorMessage, 'L·ªói k·∫øt n·ªëi Server ho·∫∑c d·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.');
console.error('L·ªói khi x√°c th·ª±c OTP:', error);
}
});

//Quay l·∫°i B∆∞·ªõc 1 (Nh·∫≠p SƒêT)
document.getElementById('btnBackToPhone').addEventListener('click', () => goToStep(1));


//--- B∆∞·ªõc 3: Render Danh s√°ch B·ªánh nh√¢n v√† Ch·ªçn BN---
function renderPatientList(patients) {
patientListDiv.innerHTML = patients.map(p => `
    <div class="patient-item" data-id="${p.id_benhnhan}" 
         onclick="selectPatientFromList('${p.id_benhnhan}')">
                                            // ^         ^ <--- TH√äM D·∫§U NH√ÅY ƒê∆†N
    <div class="item-info">
<strong>${p.ho_ten}</strong>
<p>Ng√†y sinh: ${formatDate(p.ngay_sinh)} | Gi·ªõi t√≠nh: ${p.gioi_tinh || 'N/A'}</p>
</div>
<div class="item-action"><i class="fas fa-arrow-right"></i> Xem l·ªãch s·ª≠</div>
</div>
`).join('');
}

function selectPatientFromList(patientId) {
    // patientId ·ªü ƒë√¢y l√† chu·ªói, v√≠ d·ª•: 'BN003'
    const patientObject = currentPatients.find(p => p.id_benhnhan === patientId);
    if (patientObject) {
        selectPatient(patientObject);
    }
}

// H√†m selectPatient m·ªõi: Nh·∫≠n ƒë·ªëi t∆∞·ª£ng ƒë·∫ßy ƒë·ªß
function selectPatient(patientObject) {
    selectedPatientData = patientObject; // L∆∞u to√†n b·ªô data
    const patientId = patientObject.id_benhnhan;
    const patientName = patientObject.ho_ten;

    // T·∫£i danh s√°ch l·∫ßn kh√°m cho b·ªánh nh√¢n ƒë∆∞·ª£c ch·ªçn
    loadVisits(patientId, patientName);
}


//--- B∆∞·ªõc 4: T·∫£i v√† Hi·ªÉn th·ªã Danh s√°ch L·∫ßn kh√°m (GET /api/patient/visits/:patientId)---
async function loadVisits(patientId, patientName) {
document.getElementById('visitHistoryTitle').textContent = `L·ªäCH S·ª¨ KH√ÅM c·ªßa: ${patientName || 'B·ªánh nh√¢n'}`;
visitListDiv.innerHTML = '<p style="text-align:center;">ƒêang t·∫£i l·ªãch s·ª≠ kh√°m...</p>';

// ==========================================================
// LOGIC HI·ªÇN TH·ªä TH√îNG TIN B·ªÜNH NH√ÇN ƒê·∫¶Y ƒê·ª¶ 
// ==========================================================
if (selectedPatientData && selectedPatientData.id_benhnhan) {
    document.getElementById('bnHoTen').textContent = selectedPatientData.ho_ten;
    document.getElementById('bnPhone').textContent = currentPhoneNumber; // L·∫•y SƒêT t·ª´ bi·∫øn global
    document.getElementById('bnNgaySinh').textContent = formatDate(selectedPatientData.ngay_sinh);
    document.getElementById('bnGioiTinh').textContent = selectedPatientData.gioi_tinh || 'N/A';
    document.getElementById('bnBHYT').textContent = selectedPatientData.so_bhyt || 'N/A';
    document.getElementById('bnID').textContent = selectedPatientData.id_benhnhan;
}
// ==========================================================

try {
const response = await fetch(`${API_BASE_URL}/visits/${patientId}`);
const data = await response.json();
const visits = data.visits || []; 

if (visits.length === 0) {
visitListDiv.innerHTML = `<p class="error-message">H·ªì s∆° n√†y ch∆∞a c√≥ l·ªãch s·ª≠ kh√°m n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</p>`;
} else {
visitListDiv.innerHTML = visits.map(v => `
<div class="visit-item" data-id="${v.id_lichkham}" onclick="loadVisitDetails(${v.id_lichkham}, '${formatDate(v.ngay_kham)}')">
<div class="item-info">
<strong>Ng√†y: ${formatDate(v.ngay_kham)} - Khoa: ${v.ten_khoa || 'N/A'}</strong>
<p>BS. ${v.ten_bacsi || 'N/A'} | T√≥m t·∫Øt: ${v.ket_qua ? v.ket_qua.substring(0, 40) + '...' : 'ƒêang c·∫≠p nh·∫≠t'}</p>
</div>
<div class="item-action"><i class="fas fa-file-alt"></i> Chi ti·∫øt</div>
</div>
`).join('');
}
goToStep(4);
} catch (error) {
visitListDiv.innerHTML = `<p class="error-message">L·ªói t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠ kh√°m. Vui l√≤ng ki·ªÉm tra Server.</p>`;
console.error('L·ªói khi t·∫£i l·ªãch s·ª≠ kh√°m:', error);
goToStep(4);
}
}

//Quay l·∫°i B∆∞·ªõc 3 (Ch·ªçn BN)
document.getElementById('btnBackToPatients').addEventListener('click', () => goToStep(3));


//--- B∆∞·ªõc 5: T·∫£i v√† Hi·ªÉn th·ªã Chi ti·∫øt H·ªì s∆° (Ho√†n ch·ªânh)---
async function loadVisitDetails(lichKhamId, ngayKham) {
    document.getElementById('detailTitle').textContent = `CHI TI·∫æT H·ªí S∆† KH√ÅM B·ªÜNH - Ng√†y ${ngayKham}`;
    
    // ƒê·∫∑t tr·∫°ng th√°i loading/clear cho c√°c c·ªôt
    document.getElementById('detailChanDoan').textContent = 'ƒêang t·∫£i...';
    document.getElementById('detailTrieuChung').textContent = 'ƒêang t·∫£i...';
    document.getElementById('detailThuocKeDonText').textContent = 'ƒêang t·∫£i...'; // D√≤ng t√≥m t·∫Øt thu·ªëc m·ªõi
    document.getElementById('detailGhiChu').textContent = 'ƒêang t·∫£i...';
    document.getElementById('dtTenBS').textContent = 'ƒêang t·∫£i...';
    document.getElementById('dtChuyenKhoa').textContent = 'ƒêang t·∫£i...';
    const medicationBody = document.getElementById('medicationBody');
    medicationBody.innerHTML = '';
    document.getElementById('noMedication').style.display = 'none';
    document.getElementById('medicationTable').style.display = 'none';

    // HI·ªÇN TH·ªä TH√îNG TIN B·ªÜNH NH√ÇN (L·∫•y t·ª´ selectedPatientData)
    if (selectedPatientData && selectedPatientData.id_benhnhan) {
        document.getElementById('dtHoTen').textContent = selectedPatientData.ho_ten;
        document.getElementById('dtPhone').textContent = currentPhoneNumber; 
        document.getElementById('dtNgaySinh').textContent = formatDate(selectedPatientData.ngay_sinh);
        document.getElementById('dtGioiTinh').textContent = selectedPatientData.gioi_tinh || 'N/A';
    }
    document.getElementById('dtMaHoSo').textContent = `REC-${lichKhamId.toString().padStart(3, '0')}`;

    try {
        const response = await fetch(`${API_BASE_URL}/visit-details/${lichKhamId}`);
        const data = await response.json();
        const details = data.details; 

        if (!details) {
            document.getElementById('detailChanDoan').textContent = 'Kh√¥ng t√¨m th·∫•y chi ti·∫øt h·ªì s∆°.';
            document.getElementById('detailTrieuChung').textContent = '';
            document.getElementById('detailThuocKeDonText').textContent = 'Kh√¥ng c√≥';
            document.getElementById('detailGhiChu').textContent = 'Kh√¥ng c√≥';
            document.getElementById('dtTenBS').textContent = 'N/A';
            document.getElementById('dtChuyenKhoa').textContent = 'N/A';
        } else {
            // 1. C·∫≠p nh·∫≠t chi ti·∫øt b·ªánh √°n v√† BS
            document.getElementById('detailChanDoan').textContent = details.chan_doan || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('detailTrieuChung').textContent = details.trieu_chung || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('detailGhiChu').textContent = details.ghi_chu || 'Kh√¥ng c√≥';
            
            // Th√¥ng tin B√°c sƒ© 
            document.getElementById('dtTenBS').textContent = `BS. ${details.ten_bacsi || 'N/A'}`;
            document.getElementById('dtChuyenKhoa').textContent = details.chuyen_khoa || 'N/A';
            
            // 2. C·∫≠p nh·∫≠t ƒê∆°n thu·ªëc (T√≥m t·∫Øt v√† B·∫£ng)
            let medicationArray = [];
            let medicationSummary = 'Kh√¥ng k√™ ƒë∆°n';
            
            if (details.thuoc_ke_don) {
                try {
                    medicationArray = JSON.parse(details.thuoc_ke_don);
                } catch (e) {
                    if (typeof details.thuoc_ke_don === 'string' && details.thuoc_ke_don.trim()) {
                        medicationArray.push({
                            ten_thuoc: details.thuoc_ke_don,
                            lieu_luong: 'Xem chi ti·∫øt',
                            cach_dung: 'Theo h∆∞·ªõng d·∫´n BS',
                            thoi_gian: 'ƒê·ªß li·ªáu tr√¨nh'
                        });
                    }
                }
            }
            
            if (medicationArray.length > 0) {
                // T·∫°o T√≥m t·∫Øt Thu·ªëc (d√†nh cho b·ªë c·ª•c c·ªôt)
                medicationSummary = medicationArray.map(m => m.ten_thuoc).join(', ');
                
                // Hi·ªÉn th·ªã B·∫£ng Thu·ªëc chi ti·∫øt
                document.getElementById('medicationTable').style.display = 'table';
                medicationBody.innerHTML = medicationArray.map(m => `
                    <tr>
                        <td>${m.ten_thuoc || 'N/A'}</td>
                        <td>${m.lieu_luong || 'N/A'}</td>
                        <td>${m.cach_dung || 'N/A'}</td>
                        <td>${m.thoi_gian || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('noMedication').style.display = 'block';
            }
            
            // C·∫≠p nh·∫≠t d√≤ng t√≥m t·∫Øt thu·ªëc v√†o c·ªôt m·ªõi
            document.getElementById('detailThuocKeDonText').textContent = medicationSummary;
        }
        goToStep(5);
    } catch (error) {
        document.getElementById('detailChanDoan').textContent = 'L·ªói t·∫£i chi ti·∫øt h·ªì s∆° t·ª´ Server.';
        document.getElementById('detailTrieuChung').textContent = '';
        console.error('L·ªói khi t·∫£i chi ti·∫øt h·ªì s∆°:', error);
        goToStep(5);
    }
}

//Quay l·∫°i B∆∞·ªõc 4 (L·ªãch s·ª≠ kh√°m)
document.getElementById('btnBackToVisits').addEventListener('click', () => {
    // Kh√¥ng c·∫ßn truy·ªÅn ID v√† t√™n, ch·ªâ c·∫ßn g·ªçi l·∫°i loadVisits v·ªõi data ƒë√£ l∆∞u
    loadVisits(selectedPatientData.id_benhnhan, selectedPatientData.ho_ten);
});

//--- X·ª≠ l√Ω s·ª± ki·ªán t·∫£i PDF (M√¥ ph·ªèng)---
document.getElementById('btnDownload').addEventListener('click', () => {
alert("H·ªá th·ªëng ƒëang x·ª≠ l√Ω v√† t·∫£i file PDF chi ti·∫øt h·ªì s∆° kh√°m b·ªánh v·ªÅ m√°y...");
});

//Kh·ªüi t·∫°o: ƒê·∫£m b·∫£o ch·ªâ B∆∞·ªõc 1 hi·ªán ra khi t·∫£i trang
document.addEventListener('DOMContentLoaded', () => {
goToStep(1);
});


//--- X·ª≠ l√Ω s·ª± ki·ªán t·∫£i PDF (Ho√†n ch·ªânh h∆°n)---
document.getElementById('btnDownload').addEventListener('click', async () => {
    // L·∫•y th√¥ng tin c·∫ßn thi·∫øt t·ª´ giao di·ªán
    const lichKhamId = document.getElementById('dtMaHoSo').textContent.replace('REC-', '');
    const patientName = document.getElementById('dtHoTen').textContent;
    const btn = document.getElementById('btnDownload');
    const originalText = btn.innerHTML;

    if (!lichKhamId || patientName === '...') {
        alert("L·ªói: Kh√¥ng th·ªÉ l·∫•y th√¥ng tin H·ªì s∆° b·ªánh √°n. Vui l√≤ng th·ª≠ l·∫°i sau.");
        return;
    }

    // 1. HI·ªÇN TH·ªä TR·∫†NG TH√ÅI LOADING
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o file PDF...`;
    btn.style.background = '#f4b400'; // M√†u v√†ng n·ªïi b·∫≠t khi ƒëang x·ª≠ l√Ω

    // M√î PH·ªéNG: Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ khi Server t·∫°o file (2 gi√¢y)
    await new Promise(resolve => setTimeout(resolve, 2000));

    try {
        // ======================================================================
        // üí° B∆Ø·ªöC QUAN TR·ªåNG: THAY TH·∫æ D√íNG N√ÄY B·∫∞NG API TH·ª∞C T·∫æ C·ª¶A B·∫†N
        const PDF_DOWNLOAD_ENDPOINT = `${API_BASE_URL}/visit-details/${lichKhamId}/download-pdf`; 
        // Trong m√¥i tr∆∞·ªùng TEST: D√πng URL m√¥ ph·ªèng ƒë·ªÉ k√≠ch ho·∫°t h√†nh ƒë·ªông t·∫£i file
        const mockPdfUrl = 'https://example.com/api/download/report.pdf'; 
        
        const fileUrl = PDF_DOWNLOAD_ENDPOINT; // Ho·∫∑c mockPdfUrl n·∫øu b·∫°n mu·ªën xem h√†nh ƒë·ªông t·∫£i file
        // ======================================================================

        // 2. K√çCH HO·∫†T T·∫¢I FILE
        const a = document.createElement('a');
        a.href = fileUrl;
        
        // ƒê·∫∑t t√™n file th√¢n thi·ªán
        a.download = `HoSoKhamBenh_${patientName.replace(/\s/g, '_')}_REC-${lichKhamId}.pdf`;
        
        // Trigger click ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫£i file
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // 3. TH√îNG B√ÅO HO√ÄN T·∫§T
        setTimeout(() => {
            btn.innerHTML = `<i class="fas fa-check"></i> T·∫£i file th√†nh c√¥ng!`;
            btn.style.background = '#28a745'; 
            
            // Ph·ª•c h·ªìi v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu sau 3 gi√¢y
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.style.background = ''; 
                btn.style.borderBottom = '4px solid var(--primary-dark)';
            }, 3000);

        }, 500); 
        
    } catch (error) {
        // X·ª≠ l√Ω l·ªói
        btn.innerHTML = `<i class="fas fa-times-circle"></i> L·ªói t·∫£i file!`;
        btn.style.background = '#cc0000';
        console.error('L·ªói khi t·∫£i PDF:', error);
        
        // Ph·ª•c h·ªìi tr·∫°ng th√°i sau 3 gi√¢y
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.style.background = '';
            btn.style.borderBottom = '4px solid var(--primary-dark)';
        }, 3000);
    }
});
</script>

</body>
</html>